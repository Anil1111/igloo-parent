<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:security="http://www.springframework.org/schema/security"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:p="http://www.springframework.org/schema/p"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:aop="http://www.springframework.org/schema/aop"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
						http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.1.xsd
						http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.1.xsd
						http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.1.xsd">
	
	<bean id="aclService" class="fr.openwide.core.test.jpa.security.acl.service.MockAclServiceImpl" />
	
	<bean id="permissionRegistryService" class="fr.openwide.core.jpa.security.acl.service.CorePermissionRegistryServiceImpl" />
	
	<bean id="sidRetrievalService" class="fr.openwide.core.jpa.security.acl.service.CoreSidRetrievalServiceImpl" />

	<bean id="permissionFactory" class="org.springframework.security.acls.domain.DefaultPermissionFactory" />
	
	<bean id="permissionHierarchy"
		class="fr.openwide.core.jpa.security.acl.domain.hierarchy.PermissionHierarchyImpl">
		<constructor-arg ref="permissionFactory" />
		<property name="hierarchy">
			<value>
				ADMINISTRATION > WRITE
				WRITE > READ
			</value>
		</property>
	</bean>
	
	<bean id="roleHierarchy"
		class="org.springframework.security.access.hierarchicalroles.RoleHierarchyImpl">
		<property name="hierarchy">
			<value>
				ROLE_SYSTEM > ROLE_ADMIN
				ROLE_ADMIN > ROLE_AUTHENTICATED
				ROLE_AUTHENTICATED > ROLE_ANONYMOUS
				
				ROLE_ADMIN > ROLE_GROUP_1
				ROLE_ADMIN > ROLE_GROUP_2

				ROLE_GROUP_1 > ROLE_GROUP_3
			</value>
		</property>
	</bean>
	
	<bean id="permissionEvaluator" class="fr.openwide.core.jpa.security.acl.CoreAclPermissionEvaluator"
		p:permissionFactory-ref="permissionFactory"
		p:sidRetrievalStrategy-ref="sidRetrievalService">
		<constructor-arg ref="aclService" />
	</bean>

	<bean id="expressionHandler"
		class="org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler"
		p:permissionEvaluator-ref="permissionEvaluator"
	/>
	
	<security:global-method-security pre-post-annotations="enabled" secured-annotations="enabled" run-as-manager-ref="runAsManager">
		<security:expression-handler ref="expressionHandler"/>
	</security:global-method-security>

	<bean id="coreJpaUserDetailsService"
		class="fr.openwide.core.jpa.security.service.CoreJpaUserDetailsServiceImpl"
		p:roleHierarchy-ref="roleHierarchy" />
		
	<bean id="authenticationService"
		class="fr.openwide.core.jpa.security.service.CoreAuthenticationServiceImpl" />
		
	<bean id="securityService"
		class="fr.openwide.core.jpa.security.service.CoreSecurityServiceImpl" />

	<bean id="runAsManager" class="fr.openwide.core.jpa.security.runas.CoreRunAsManagerImpl"
		p:key="aet5aiSh" />
	
	<bean id="runAsAuthenticationProvider" class="org.springframework.security.access.intercept.RunAsImplAuthenticationProvider"
		p:key="aet5aiSh" />
		
	<security:authentication-manager>
		<security:authentication-provider ref="runAsAuthenticationProvider" />
		<security:authentication-provider user-service-ref="coreJpaUserDetailsService">
			<security:password-encoder hash="md5" />
		</security:authentication-provider>
	</security:authentication-manager>
	
</beans>